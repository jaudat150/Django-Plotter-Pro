{% extends 'plot_app/base.html' %}
{% load static %}

{% block title %}Create New Plot{% endblock %}

{% block content %}
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <h1 class="h4 mb-0"><i class="fas fa-chart-line me-2"></i>Create Plot</h1>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" id="plot-form">
            {% csrf_token %}
            
            <!-- Data Input Method Tabs -->
            <ul class="nav nav-tabs mb-4" id="dataInputTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-data" type="button" role="tab" aria-controls="manual-data" aria-selected="true">
                        <i class="fas fa-keyboard me-1"></i>Manual Entry
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="csv-tab" data-bs-toggle="tab" data-bs-target="#csv-upload" type="button" role="tab" aria-controls="csv-upload" aria-selected="false">
                        <i class="fas fa-file-csv me-1"></i>CSV Upload
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="dataInputContent">
                <!-- Manual Data Entry Tab -->
                <div class="tab-pane fade show active" id="manual-data" role="tabpanel" aria-labelledby="manual-tab">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_x_data" class="form-label">X Values <span class="text-muted">(comma or space separated)</span></label>
                                <textarea id="id_x_data" name="x_data" class="form-control" rows="6" placeholder="Example: 1, 2, 3, 4, 5 or 1 2 3 4 5">{{ request.POST.x_data }}</textarea>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i> Enter numbers separated by commas or spaces
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_y_data" class="form-label">Y Values <span class="text-muted">(comma or space separated)</span></label>
                                <textarea id="id_y_data" name="y_data" class="form-control" rows="6" placeholder="Example: 10, 20, 30, 40, 50 or 10 20 30 40 50">{{ request.POST.y_data }}</textarea>
                                <div class="form-text">
                                    <i class="fas fa-exclamation-triangle me-1"></i> Must have same number of values as X
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sample Data Buttons -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h2 class="h6 mb-0"><i class="fas fa-magic me-2"></i>Generate Sample Data</h2>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="generateSampleData('linear')">
                                    <i class="fas fa-chart-line me-1"></i>Linear (y = 2x + 1)
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" onclick="generateSampleData('quadratic')">
                                    <i class="fas fa-chart-line me-1"></i>Quadratic (y = xÂ²)
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="generateSampleData('sinusoidal')">
                                    <i class="fas fa-chart-line me-1"></i>Sinusoidal (y = sin(x))
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-warning" onclick="generateSampleData('random')">
                                    <i class="fas fa-chart-line me-1"></i>Random Data
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearData()">
                                    <i class="fas fa-trash me-1"></i>Clear Data
                                </button>
                            </div>
                            <div class="mt-3 p-3 bg-light rounded">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i> Tip: You can paste data directly from Excel or Google Sheets!
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- CSV Upload Tab -->
                <div class="tab-pane fade" id="csv-upload" role="tabpanel" aria-labelledby="csv-tab">
                    <div class="card border-primary mb-4">
                        <div class="card-header bg-primary text-white">
                            <h2 class="h6 mb-0"><i class="fas fa-file-csv me-2"></i>Upload CSV File</h2>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="id_csv_file" name="csv_file" accept=".csv">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i> CSV format: Two columns (X and Y values). First row can be headers.
                                </div>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="id_has_header" name="has_header" checked>
                                <label class="form-check-label" for="id_has_header">
                                    CSV file has header row
                                </label>
                            </div>
                            
                            <div class="alert alert-info">
                                <h3 class="h6 mb-2"><i class="fas fa-file-alt me-1"></i> CSV Format Example:</h3>
                                <pre class="mb-0">x_value,y_value
1,10
2,20
3,30
4,40</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Plot Configuration -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h2 class="h6 mb-0"><i class="fas fa-cog me-2"></i>Plot Configuration</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                            {{ form.title }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.plot_type.id_for_label }}" class="form-label">{{ form.plot_type.label }}</label>
                            {{ form.plot_type }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.x_label.id_for_label }}" class="form-label">{{ form.x_label.label }}</label>
                            {{ form.x_label }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.y_label.id_for_label }}" class="form-label">{{ form.y_label.label }}</label>
                            {{ form.y_label }}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Notes -->
            <div class="mb-4">
                <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
                {{ form.notes }}
            </div>
            
            <!-- Submit Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{% url 'plot_app:saved_plots' %}" class="btn btn-outline-secondary me-md-2">
                    <i class="fas fa-database me-1"></i>View Saved Plots
                </a>
                <button type="submit" class="btn btn-primary px-4">
                    <i class="fas fa-chart-line me-2"></i>Generate Plot
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Enhanced data parsing function
    function parseDataInput(input) {
        // Handle both comma and space separated values
        return input.split(/[\s,]+/)
            .map(val => val.trim())
            .filter(val => val !== '')
            .map(val => parseFloat(val));
    }
    
    function validateData() {
        const xInput = document.getElementById('id_x_data').value;
        const yInput = document.getElementById('id_y_data').value;
        
        const xValues = parseDataInput(xInput);
        const yValues = parseDataInput(yInput);
        
        if (xValues.length === 0 || yValues.length === 0) {
            alert('Please enter values for both X and Y data!');
            return false;
        }
        
        if (xValues.length !== yValues.length) {
            alert(`Data length mismatch!\nX values: ${xValues.length}\nY values: ${yValues.length}\nBoth must have the same number of values.`);
            return false;
        }
        
        // Check for invalid numbers
        const invalidX = xValues.some(isNaN);
        const invalidY = yValues.some(isNaN);
        
        if (invalidX || invalidY) {
            alert('Invalid numbers detected! Please ensure all values are valid numbers.');
            return false;
        }
        
        return true;
    }
    
    // Sample data generators
    window.generateSampleData = function(type) {
        let xData, yData;
        
        switch(type) {
            case 'linear':
                xData = Array.from({length: 10}, (_, i) => i + 1);
                yData = xData.map(x => 2 * x + 1);
                break;
            case 'quadratic':
                xData = Array.from({length: 11}, (_, i) => i - 5);
                yData = xData.map(x => x * x);
                break;
            case 'sinusoidal':
                xData = Array.from({length: 20}, (_, i) => i * 0.5 - 5);
                yData = xData.map(x => Math.sin(x) * 10);
                break;
            case 'random':
                xData = Array.from({length: 15}, (_, i) => i + 1);
                yData = xData.map(() => (Math.random() - 0.5) * 100);
                break;
        }
        
        document.getElementById('id_x_data').value = xData.join(', ');
        document.getElementById('id_y_data').value = yData.join(', ');
    };
    
    window.clearData = function() {
        document.getElementById('id_x_data').value = '';
        document.getElementById('id_y_data').value = '';
    };
    
    // Form submission validation
    document.getElementById('plot-form').addEventListener('submit', function(e) {
        const csvFile = document.getElementById('id_csv_file').files.length > 0;
        
        if (!csvFile) {
            if (!validateData()) {
                e.preventDefault();
            }
        }
    });
    
    // Real-time feedback
    document.getElementById('id_x_data').addEventListener('input', updateDataPreview);
    document.getElementById('id_y_data').addEventListener('input', updateDataPreview);
    
    function updateDataPreview() {
        const xInput = document.getElementById('id_x_data').value;
        const yInput = document.getElementById('id_y_data').value;
        
        const xCount = parseDataInput(xInput).length;
        const yCount = parseDataInput(yInput).length;
        
        const xPreview = document.querySelector('#manual-data .form-text:first-child');
        const yPreview = document.querySelector('#manual-data .form-text:last-child');
        
        if (xPreview) {
            xPreview.innerHTML = `<i class="fas fa-info-circle me-1"></i> ${xCount} values entered`;
            xPreview.className = xCount > 0 ? 'form-text text-success' : 'form-text';
        }
        
        if (yPreview) {
            yPreview.innerHTML = `<i class="fas fa-info-circle me-1"></i> ${yCount} values entered`;
            yPreview.className = yCount > 0 ? 'form-text text-success' : 'form-text';
            
            if (xCount > 0 && yCount > 0 && xCount !== yCount) {
                yPreview.innerHTML = `<i class="fas fa-exclamation-triangle me-1 text-danger"></i> ${yCount} values (mismatch: X has ${xCount})`;
                yPreview.className = 'form-text text-danger';
            }
        }
    }
</script>
{% endblock %}